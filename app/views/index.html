<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Просмотр камер</title>
</head>
<body>
    <h1>Камеры</h1>

    <!-- Кнопки и селекты (как у вас) -->
    <button id="loadTrucks">Загрузить грузовики</button>
    <select id="truckSelect"></select>
    <button id="startCameras">Старт камер</button>
    <button id="stopCameras">Стоп камер</button>

    <!-- Видеопотоки -->
    <div id="cameraStream" class="d-none">
        <h2>Front</h2>
        <img id="frontCamera" src="" width="320" height="240">

        <h2>Back</h2>
        <img id="backCamera" src="" width="320" height="240">

        <h2>Left</h2>
        <img id="leftCamera" src="" width="320" height="240">

        <h2>Right</h2>
        <img id="rightCamera" src="" width="320" height="240">
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const loadTrucksButton = document.getElementById("loadTrucks");
            const truckSelect = document.getElementById("truckSelect");
            const startButton = document.getElementById("startCameras");
            const stopButton = document.getElementById("stopCameras");
            const cameraStream = document.getElementById("cameraStream");

            const frontCamera = document.getElementById("frontCamera");
            const backCamera  = document.getElementById("backCamera");
            const leftCamera  = document.getElementById("leftCamera");
            const rightCamera = document.getElementById("rightCamera");

            function loadTrucks() {
                fetch("/api/trucks")
                    .then(response => response.json())
                    .then(data => {
                        truckSelect.innerHTML = '<option value="">Выберите грузовик...</option>';
                        data.forEach(truck => {
                            let option = document.createElement("option");
                            option.value = truck.stateNumber;
                            option.textContent = `${truck.name} (${truck.stateNumber})`;
                            truckSelect.appendChild(option);
                        });
                        alert("Список грузовиков загружен!");
                    })
                    .catch(error => {
                        console.error("Ошибка загрузки списка грузовиков:", error);
                        alert("Ошибка загрузки списка!");
                    });
            }

            function startCameras() {
                const selectedTruck = truckSelect.value;
                if (!selectedTruck) {
                    alert("Выберите грузовик!");
                    return;
                }

                fetch("/api/start_cameras", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ truck_number: selectedTruck })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        alert(data.message);

                        // Прописываем ссылку на поток
                        frontCamera.src = `/video_feed/front`;
                        backCamera.src  = `/video_feed/back`;
                        leftCamera.src  = `/video_feed/left`;
                        rightCamera.src = `/video_feed/right`;
                        

                        cameraStream.classList.remove("d-none");
                    } else {
                        alert(data.error);
                    }
                })
                .catch(error => {
                    console.error("Ошибка запуска камер:", error);
                    alert("Ошибка запуска камер!");
                });
            }

            function stopCameras() {
                fetch("/api/stop_cameras", { method: "POST" })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    frontCamera.src = "";
                    backCamera.src  = "";
                    leftCamera.src  = "";
                    rightCamera.src = "";

                    cameraStream.classList.add("d-none");
                })
                .catch(error => {
                    console.error("Ошибка остановки камер:", error);
                    alert("Ошибка остановки камер!");
                });
            }

            loadTrucksButton.addEventListener("click", loadTrucks);
            startButton.addEventListener("click", startCameras);
            stopButton.addEventListener("click", stopCameras);
        });
    </script>
</body>
</html>
